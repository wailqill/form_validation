<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <script src="../lib/prototype.js" type="text/javascript" charset="utf-8"></script>
  <script src="../lib/unittest.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="../lib/test.css" type="text/css" media="screen" charset="utf-8">

  <script src="../src/wq.form_validator.js" type="text/javascript" charset="utf-8"></script>
	<title>Form.Validator: validator tests</title>
	
</head>

<body>
  <h2>Validator tests</h2>

<!-- Log output -->
<div id="testlog"></div>

<script type="text/javascript" charset="utf-8">
// <![CDATA[
var fv = null;
new Test.Unit.Runner({
	setup: function() {
		fv = new wq.Form.Validation("my-form");
	},
	teardown: function() {
	  wq.Form.Validation.remove("my-form");
	},
  test_class_should_exist: function() {
    this.assert(wq.Form.Validation.Validators);
    this.assert(wq.Form.Validation.Validators.EmailFormats);
  },
  test_validate_required: function() {
    var elm = new wq.Form.Validation.Element("person_field", { required: true });
    
    inputTextAssertFalse(this, elm, null);
    inputTextAssertFalse(this, elm, "");
    
    inputTextAssertTrue(this, elm, "Glenn");
    inputTextAssertTrue(this, elm, "false");
  },
  test_email_formats: function() {
    this.assert(wq.Form.Validation.Validators.EmailFormats.RFC2822 instanceof RegExp);
    this.assert(wq.Form.Validation.Validators.EmailFormats.RealisticRFC2822 instanceof RegExp);
  },
  test_ensure_default_validation_is_RealisticRFC2822: function(){
    var elm = new wq.Form.Validation.Element("person_field", { email: true });
    this.assertIdentical(wq.Form.Validation.Validators.EmailFormats.RealisticRFC2822, elm.options.email);
  }  ,
    test_validate_email_RFC2822: function() {
      var elm = new wq.Form.Validation.Element("person_field", { email: wq.Form.Validation.Validators.EmailFormats.RFC2822 });

      inputTextAssertFalse(this, elm, "");                        // Doh!
      inputTextAssertFalse(this, elm, "Hello there");             // No @
      inputTextAssertFalse(this, elm, "elm@elm");                 // No TLD
      inputTextAssertFalse(this, elm, "elm@el m.com");            // Space not allowed in host

      inputTextAssertTrue(this, elm, "test@example.haleluja");    // RFC doesn't restrict the TLD
      inputTextAssertTrue(this, elm, "test@example.com");         // Standard
      inputTextAssertTrue(this, elm, "test@100.100.100.100");     // With ip based host
      inputTextAssertTrue(this, elm, '"test"@example.com');       // With double quotes
      inputTextAssertTrue(this, elm, '"Hey\\ ho"@example.com');   // With space
    },
    test_validate_email_RealisticRFC2822: function() {
      var elm = new wq.Form.Validation.Element("person_field", { email: wq.Form.Validation.Validators.EmailFormats.RealisticRFC2822 });
      
      inputTextAssertFalse(this, elm, "");
      inputTextAssertFalse(this, elm, "Hello there");
      inputTextAssertFalse(this, elm, "elm@elm");
      inputTextAssertFalse(this, elm, "elm@el m.com");
      inputTextAssertFalse(this, elm, "test@example.haleluja");   // Bad TLD
      inputTextAssertFalse(this, elm, '"test"@example.com');      // Double quotes
      inputTextAssertFalse(this, elm, '"Hey\\ ho"@example.com');  // Space
      inputTextAssertFalse(this, elm, "test@100.100.100.100");    // IP based host
                                                                  
      "aero,arpa,asia,biz,cat,com,coop,edu,gov,info,int,jobs,mil,mobi,museum,name,net,org,pro,tel,travel,xn--0zwm56d,xn--11b5bs3a9aj6g,xn--80akhbyknj4f,xn--9t4b11yi5a,xn--deba0ad,xn--g6w251d,xn--hgbk6aj7f53bba,xn--hlcj6aya9esc7a,xn--jxalpdlp,xn--kgbechtv,xn--zckzah".split(",").each(function(tld) {
        inputTextAssertTrue(this, elm, "test@example." + tld);    // With every defined TLD
      }.bind(this));
      
      var range = $R("a", "z");
      range.each(function(first) {
        range.each(function(last) {
          inputTextAssertTrue(this, elm, "test@example." + first + last);  // Every possible 2-letter combination of a-z
        }.bind(this));
      }.bind(this));
    }
});

function inputTextAssertTrue(o, elm, value) { return inputTextAssertion(o, elm, value, true); }
function inputTextAssertFalse(o, elm, value) { return inputTextAssertion(o, elm, value, false); }
function inputTextAssertion(o, elm, value, expected) {
  elm.element.value = value;
  o.assertIdentical(expected, elm.validate());
}

// ]]>
</script>

<form action="#" method="get" accept-charset="utf-8" id="my-form">
  <p>
    <label for="name">Field</label><input type="text" name="person[field]" value="" id="person_field">
  </p>
</form>

</body>
</html>
